# name: CI/CD Pipeline

# on:
#   push:
#     branches: [main, develop]
#   pull_request:
#     branches: [main, develop]

# jobs:
#   # ============================================
#   # Code Quality & Testing
#   # ============================================
#   test:
#     name: Test (PHP ${{ matrix.php }})
#     runs-on: ubuntu-latest
    
#     strategy:
#       fail-fast: false
#       matrix:
#         php: ['8.1', '8.2', '8.3']
    
#     services:
#       mysql:
#         image: mysql:8.0
#         env:
#           MYSQL_ROOT_PASSWORD: password
#           MYSQL_DATABASE: ticket_manage_test
#         ports:
#           - 3306:3306
#         options: >-
#           --health-cmd="mysqladmin ping"
#           --health-interval=10s
#           --health-timeout=5s
#           --health-retries=3

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: ${{ matrix.php }}
#           extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, mysql, pdo_mysql, bcmath, soap, intl, gd, exif, iconv
#           coverage: xdebug

#       - name: Get Composer cache directory
#         id: composer-cache
#         run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

#       - name: Cache Composer dependencies
#         uses: actions/cache@v4
#         with:
#           path: ${{ steps.composer-cache.outputs.dir }}
#           key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
#           restore-keys: ${{ runner.os }}-composer-

#       - name: Install Composer dependencies
#         run: composer install --no-progress --prefer-dist --optimize-autoloader

#       - name: Copy environment file
#         run: cp .env.example .env

#       - name: Generate application key
#         run: php artisan key:generate

#       - name: Configure database
#         run: |
#           php artisan config:clear
#           php artisan cache:clear
#         env:
#           DB_CONNECTION: mysql
#           DB_HOST: 127.0.0.1
#           DB_PORT: 3306
#           DB_DATABASE: ticket_manage_test
#           DB_USERNAME: root
#           DB_PASSWORD: password

#       - name: Run migrations
#         run: php artisan migrate --force
#         env:
#           DB_CONNECTION: mysql
#           DB_HOST: 127.0.0.1
#           DB_PORT: 3306
#           DB_DATABASE: ticket_manage_test
#           DB_USERNAME: root
#           DB_PASSWORD: password

#       - name: Run tests
#         run: php artisan test --parallel
#         env:
#           DB_CONNECTION: mysql
#           DB_HOST: 127.0.0.1
#           DB_PORT: 3306
#           DB_DATABASE: ticket_manage_test
#           DB_USERNAME: root
#           DB_PASSWORD: password

#   # ============================================
#   # Laravel Pint (Code Style)
#   # ============================================
#   pint:
#     name: Laravel Pint
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.2'
#           coverage: none

#       - name: Install Composer dependencies
#         run: composer install --no-progress --prefer-dist --optimize-autoloader

#       - name: Run Laravel Pint
#         run: vendor/bin/pint --test

#   # ============================================
#   # Static Analysis (PHPStan - Optional)
#   # ============================================
#   # phpstan:
#   #   name: PHPStan
#   #   runs-on: ubuntu-latest
#   #   
#   #   steps:
#   #     - name: Checkout code
#   #       uses: actions/checkout@v4
#   #
#   #     - name: Setup PHP
#   #       uses: shivammathur/setup-php@v2
#   #       with:
#   #         php-version: '8.2'
#   #         coverage: none
#   #
#   #     - name: Install Composer dependencies
#   #       run: composer install --no-progress --prefer-dist --optimize-autoloader
#   #
#   #     - name: Run PHPStan
#   #       run: vendor/bin/phpstan analyse --memory-limit=2G

#   # ============================================
#   # Frontend Build
#   # ============================================
#   frontend:
#     name: Frontend Build
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'
#           cache: 'npm'

#       - name: Install NPM dependencies
#         run: npm ci

#       - name: Build frontend assets
#         run: npm run build

#       - name: Upload build artifacts
#         uses: actions/upload-artifact@v4
#         with:
#           name: frontend-build
#           path: public/build
#           retention-days: 1

#   # ============================================
#   # Security Audit
#   # ============================================
#   security:
#     name: Security Audit
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.2'
#           coverage: none

#       - name: Install Composer dependencies
#         run: composer install --no-progress --prefer-dist --optimize-autoloader

#       - name: Run security checker
#         run: composer audit

#   # ============================================
#   # Deploy to Staging (on develop branch)
#   # ============================================
#   deploy-staging:
#     name: Deploy to Staging
#     runs-on: ubuntu-latest
#     needs: [test, pint, frontend, security]
#     if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
#     environment: staging
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Download frontend build
#         uses: actions/download-artifact@v4
#         with:
#           name: frontend-build
#           path: public/build

#       - name: Deploy to staging server
#         run: |
#           echo "ðŸš€ Deploying to staging..."
#           # Add your deployment commands here
#           # Example using SSH:
#           # ssh ${{ secrets.STAGING_SSH_USER }}@${{ secrets.STAGING_SSH_HOST }} 'cd /var/www/staging && git pull && composer install --no-dev && php artisan migrate --force'

#   # ============================================
#   # Deploy to Production (on main branch)
#   # ============================================
#   deploy-production:
#     name: Deploy to Production
#     runs-on: ubuntu-latest
#     needs: [test, pint, frontend, security]
#     if: github.ref == 'refs/heads/main' && github.event_name == 'push'
#     environment: production
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Download frontend build
#         uses: actions/download-artifact@v4
#         with:
#           name: frontend-build
#           path: public/build

#       - name: Deploy to production server
#         run: |
#           echo "ðŸš€ Deploying to production..."
#           # Add your deployment commands here
#           # Example using Laravel Envoy or SSH:
#           # php vendor/bin/envoy run deploy --server=production
